name: ESP-IDF Firmware Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:v5.3 # Use the correct pre-built ESP-IDF container

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive # Needed if you have ESP-IDF components as submodules

    - name: Build ESP-IDF project
      working-directory: ./firmware # Change working directory to your firmware project
      run: |
        # Source the ESP-IDF export script to ensure idf.py is in PATH
        # This path might vary depending on the container image.
        # Common locations are /opt/esp/idf/export.sh or /esp/idf/export.sh
        if [ -f /opt/esp/idf/export.sh ]; then
          . /opt/esp/idf/export.sh
        elif [ -f /esp/idf/export.sh ]; then
          . /esp/idf/export.sh
        else
          echo "Warning: ESP-IDF export.sh not found in common locations. idf.py might not be in PATH."
        fi
        
        idf.py reconfigure
        idf.py build \
          -DCONFIG_WIFI_SSID="${{ secrets.WIFI_SSID }}" \
          -DCONFIG_WIFI_PASSWORD="${{ secrets.WIFI_PASSWORD }}" \
          -DCONFIG_MQTT_HOST="${{ secrets.MQTT_HOST }}" \
          -DCONFIG_MQTT_PORT=${{ secrets.MQTT_PORT }} \
          -DCONFIG_MQTT_USERNAME="${{ secrets.MQTT_USERNAME }}" \
          -DCONFIG_MQTT_PASSWORD="${{ secrets.MQTT_PASSWORD }}" \
          -DCONFIG_TELEGRAM_ENABLED=${{ secrets.TELEGRAM_ENABLED }} \
          -DCONFIG_TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
          -DCONFIG_TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -DCONFIG_USE_STATIC_IP=${{ secrets.USE_STATIC_IP }} \
          -DCONFIG_STATIC_IP_ADDRESS_OCTETS="${{ secrets.STATIC_IP_ADDRESS_OCTETS }}" \
          -DCONFIG_STATIC_GATEWAY_OCTETS="${{ secrets.STATIC_GATEWAY_OCTETS }}" \
          -DCONFIG_STATIC_SUBNET_OCTETS="${{ secrets.STATIC_SUBNET_OCTETS }}" \
          -DCONFIG_STATIC_DNS_OCTETS="${{ secrets.STATIC_DNS_OCTETS }}"
