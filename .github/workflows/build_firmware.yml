name: ESP-IDF Firmware Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    container: espressif/idf:latest # Use the correct pre-built ESP-IDF container

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive # Needed if you have ESP-IDF components as submodules

    - name: Set up Python environment
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install ESP-IDF Python dependencies
      run: |
        python -m pip install -r $IDF_PATH/requirements.txt
        python -m pip install -r $IDF_PATH/tools/kconf_gen/requirements.txt # For kconf_gen if used

    - name: Build ESP-IDF project
      working-directory: ./firmware # Change working directory to your firmware project
      run: |
        idf.py build \
          -DCONFIG_WIFI_SSID="${{ secrets.WIFI_SSID }}" \
          -DCONFIG_WIFI_PASSWORD="${{ secrets.WIFI_PASSWORD }}" \
          -DCONFIG_MQTT_HOST="${{ secrets.MQTT_HOST }}" \
          -DCONFIG_MQTT_PORT=${{ secrets.MQTT_PORT }} \
          -DCONFIG_MQTT_USERNAME="${{ secrets.MQTT_USERNAME }}" \
          -DCONFIG_MQTT_PASSWORD="${{ secrets.MQTT_PASSWORD }}" \
          -DCONFIG_TELEGRAM_ENABLED=${{ secrets.TELEGRAM_ENABLED }} \
          -DCONFIG_TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}" \
          -DCONFIG_TELEGRAM_CHAT_ID="${{ secrets.TELEGRAM_CHAT_ID }}" \
          -DCONFIG_USE_STATIC_IP=${{ secrets.USE_STATIC_IP }} \
          -DCONFIG_STATIC_IP_ADDRESS_OCTETS="${{ secrets.STATIC_IP_ADDRESS_OCTETS }}" \
          -DCONFIG_STATIC_GATEWAY_OCTETS="${{ secrets.STATIC_GATEWAY_OCTETS }}" \
          -DCONFIG_STATIC_SUBNET_OCTETS="${{ secrets.STATIC_SUBNET_OCTETS }}" \
          -DCONFIG_STATIC_DNS_OCTETS="${{ secrets.STATIC_DNS_OCTETS }}"
